{"version":"NotebookV1","origId":3312318445443458,"name":"util_functions2","language":"python","commands":[{"version":"CommandV1","origId":8576460854135310,"guid":"c875d948-3f0e-4f28-b989-d23e480d2f4b","subtype":"command","commandType":"auto","position":0.5,"command":"%pip install word2number","commandVersion":2,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"091c523a-36d9-4d3e-afb9-fb90e63708f3"},{"version":"CommandV1","origId":8576460854135311,"guid":"4ad0f9ae-bd68-4a7a-9307-4cd5f8de63df","subtype":"command","commandType":"auto","position":0.75,"command":"from pyspark.sql.functions import udf, col\nfrom pyspark.sql.types import IntegerType\nfrom word2number import w2n\n\ndef word_to_num(value):\n    try:\n        # If already numeric\n        return int(value)\n    except:\n        try:\n            return w2n.word_to_num(value.lower())\n        except:\n            return None\n\nword_to_num_udf = udf(word_to_num, IntegerType())\n","commandVersion":1,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"906a486e-d5db-4ded-85b9-fe7a51e3d0b2"},{"version":"CommandV1","origId":6823053943555641,"guid":"c58b6eb7-c473-4775-8e54-6a0d126a462d","subtype":"command","commandType":"auto","position":1.3333333333333333,"command":"#Return Spark session\nfrom pyspark.sql.session import SparkSession\ndef get_spark_session(app_name=\"Some Anonymous Data Engineering Project\"):\n    try:\n        spark = SparkSession.getActiveSession()\n        if spark:\n            return spark\n    except:\n        pass\n\n    return (SparkSession.builder.appName(app_name).getOrCreate())\n\n","commandVersion":7,"state":"finished","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":1768666049495,"submitTime":1768666048995,"finishTime":1768666049712,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{"rowLimit":10000,"byteLimit":2048000},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"4c42bf4a-cd7e-4685-aca7-a5d7b171f822"},{"version":"CommandV1","origId":6823053943555642,"guid":"c14921b4-40cc-45fc-bc45-ac7b9b146306","subtype":"command","commandType":"auto","position":1.6666666666666665,"command":"#All generic functions for reading data from files & tables\n\ndef read_csv_df(spark,path,header=True,infer_schema=True,sep=\",\"):\n    return_df=spark.read.option(\"header\", header).option(\"inferSchema\", infer_schema)\\\n        .option(\"sep\", sep)\\\n        .csv(path)\n    return return_df\n\ndef read_json_df(spark, path,mline=True):\n    return spark.read.json(path,multiLine=mline,mode=\"PERMISSIVE\")\n\n   \ndef read_delta_df(spark,path):\n    return spark.read.format(\"delta\").load(path)\n\ndef read_file(spark,filetype,path,header=True,infer_schema=True,mline=True):\n    if filetype==\"csv\":\n        return spark.read.csv(path,header=header,inferSchema=infer_schema)#read_csv_df(spark,path)\n    elif filetype==\"json\":\n        return read_json_df(spark,path)\n    elif filetype==\"delta\":\n        return read_delta_df(spark,path)\n    elif filetype=='orc':\n        return spark.read.orc(path)\n    else:\n        raise Exception(\"File type not supported\")\n\n\ndef read_table(spark,table_name):\n    return spark.table(table_name)","commandVersion":68,"state":"finished","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":1768666049740,"submitTime":1768666048996,"finishTime":1768666049872,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{"rowLimit":10000,"byteLimit":2048000},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"342ddd87-0e33-4fb8-af94-49a5efaaddc7"},{"version":"CommandV1","origId":6823053943555643,"guid":"2a430a65-8ba1-4ad8-ae9a-5c72e79ad047","subtype":"command","commandType":"auto","position":1.9999999999999998,"command":"#Return Joined DF\ndef join_df(df1,df2,how=\"inner\",on=\"shipment_id\"):#To avoid cartesian/cross join, i am adding some column in the on\n    return df1.join(df2, on=on, how=how)\n\n\ndef mergeDf(df1,df2,allowmissingcol=True):\n    return df1.unionByName(df2, allowMissingColumns=allowmissingcol)","commandVersion":3,"state":"finished","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":1768666049910,"submitTime":1768666048997,"finishTime":1768666050075,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{"rowLimit":10000,"byteLimit":2048000},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"6c15ae68-11f5-4ff6-a474-ea9358fa5dd2"},{"version":"CommandV1","origId":6823053943555644,"guid":"22859987-fb24-4f1e-a7e0-ddc2e20b77d6","subtype":"command","commandType":"auto","position":2.333333333333333,"command":"from pyspark.sql.functions import lit\ndef add_literal_columns(df, columns, default_value=None):\n    for col_name in columns:\n        df = df.withColumn(col_name, lit(default_value))\n    return df\n","commandVersion":0,"state":"finished","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":1768666050093,"submitTime":1768666048999,"finishTime":1768666050288,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{"rowLimit":10000,"byteLimit":2048000},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"36ec6b70-4d7e-4ffc-a105-3a044815366f"},{"version":"CommandV1","origId":6926205340395075,"guid":"efc8971a-6808-4c8f-b244-81402eebdada","subtype":"command","commandType":"auto","position":1.0,"command":"from pyspark.sql import functions as F\nfrom pyspark.sql.window import Window\n\ndef standardize_staff(df):\n    return (\n        df\n        .withColumn(\"shipment_id\",word_to_num_udf(F.col(\"shipment_id\")).cast(\"long\"))\n        .withColumn(\"age\",word_to_num_udf(F.col(\"age\")).cast(\"int\"))\n        .withColumn(\"role\", F.lower(\"role\"))\n        .withColumn(\"origin_hub_city\", F.initcap(\"hub_location\"))\n        .withColumn(\"load_dt\", F.current_timestamp())\n        .withColumn(\"full_name\", F.concat_ws(\" \", \"first_name\", \"last_name\"))\n        .withColumn(\"hub_location\", F.initcap(\"hub_location\"))\n        .drop(\"first_name\", \"last_name\")\n        .withColumnRenamed(\"full_name\", \"staff_full_name\")\n    )\n\ndef scrub_geotag(df):\n    return (\n        df\n        .withColumn(\"city_name\", F.initcap(\"city_name\"))\n        .withColumn(\"masked_hub_location\", F.initcap(\"country\"))\n    )\n\ndef standardize_shipments(df):\n    return (\n        df\n        .withColumn(\"domain\", F.lit(\"Logistics\"))\n        .withColumn(\"ingestion_timestamp\", F.current_timestamp())\n        .withColumn(\"is_expedited\", F.lit(False).cast(\"boolean\"))\n        .withColumn(\"shipment_date\", F.to_date(\"shipment_date\", \"yy-MM-dd\"))\n        .withColumn(\"shipment_cost\", F.round(\"shipment_cost\", 2))\n        .withColumn(\"shipment_weight_kg\", F.col(\"shipment_weight_kg\").cast(\"double\"))\n    )\n\ndef enrich_shipments(df):\n    return (\n        df\n        .withColumn(\"route_segment\",\n            F.concat_ws(\"-\", \"source_city\", \"destination_city\"))\n        .withColumn(\"vehicle_identifier\",\n            F.concat_ws(\"_\", \"vehicle_type\", \"shipment_id\"))\n        .withColumn(\"shipment_year\", F.year(\"shipment_date\"))\n        .withColumn(\"shipment_month\", F.month(\"shipment_date\"))\n        .withColumn(\"is_weekend\",\n            F.dayofweek(\"shipment_date\").isin([1,7]))\n        .withColumn(\"is_expedited\",\n            F.col(\"shipment_status\").isin(\"IN_TRANSIT\", \"DELIVERED\"))\n        .withColumn(\"cost_per_kg\",\n            F.round(F.col(\"shipment_cost\") / F.col(\"shipment_weight_kg\"), 2))\n        .withColumn(\"tax_amount\",\n            F.round(F.col(\"shipment_cost\") * 0.18, 2))\n        .withColumn(\"days_since_shipment\",\n            F.datediff(F.current_date(), \"shipment_date\"))\n        .withColumn(\"is_high_value\",\n            F.col(\"shipment_cost\") > 50000)\n    )\n\ndef split_columns(df):\n    return (\n        df\n        .withColumn(\"order_prefix\", F.substring(\"order_id\", 1, 3))\n        .withColumn(\"order_sequence\", F.substring(\"order_id\", 4, 10))\n        .withColumn(\"ship_year\", F.year(\"shipment_date\"))\n        .withColumn(\"ship_month\", F.month(\"shipment_date\"))\n        .withColumn(\"ship_day\", F.dayofmonth(\"shipment_date\"))\n        .withColumn(\"route_lane\",\n            F.concat_ws(\"->\", \"source_city\", \"destination_city\"))\n    )\n\ndef mask_name(col):\n    return F.concat(\n        F.substring(col, 1, 2),\n        F.lit(\"****\"),\n        F.substring(col, -1, 1)\n    )\n\n","commandVersion":111,"state":"finished","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":1768666049056,"submitTime":1768666048993,"finishTime":1768666049404,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{"rowLimit":10000,"byteLimit":2048000},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"ca134f5d-35c9-419f-8d8b-7fa1e19c3509"},{"version":"CommandV1","origId":6823053943555646,"guid":"083a61c3-6b48-461a-b8e2-f9c8e3c3c403","subtype":"command","commandType":"auto","position":3.666666666666666,"command":"#All generic functions for writing data to files & tables\n\ndef write_file(df, path, mode=\"overwrite\", format=\"delta\"):\n    return df.write.mode(mode).format(format).save(path)\n\ndef write_table(df, tablename, mode=\"overwrite\"):\n    df.write.mode(mode).format(\"delta\").saveAsTable(tablename)    ","commandVersion":25,"state":"finished","results":{"type":"listResults","data":[],"arguments":{},"addedWidgets":{},"removedWidgets":[],"datasetInfos":[],"metadata":{"isDbfsCommandResult":false}},"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":1768666050534,"submitTime":1768666049001,"finishTime":1768666050679,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{"rowLimit":10000,"byteLimit":2048000},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"a8571e16-3f59-4f75-80d9-7c1076b4a14c"},{"version":"CommandV1","origId":7047108631865633,"guid":"0ca0f76b-ef2a-48a6-9bf0-e9a3c4778b26","subtype":"command","commandType":"auto","position":1.1666666666666665,"command":"%md\n###Generic Functions","commandVersion":3,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"fa396482-29cd-4a3d-a9ce-c3b06d081453"},{"version":"CommandV1","origId":7047108631865634,"guid":"89dc7b51-e270-45d8-8c48-5f0201b65db0","subtype":"command","commandType":"auto","position":0.875,"command":"%md\n###Inline/Business Specific Functions","commandVersion":2,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"6d6f659f-ba9e-48be-b4ea-0abfade4809b"},{"version":"CommandV1","origId":7047108631865638,"guid":"5742b29e-9946-44b6-9ce7-0abdb237657b","subtype":"command","commandType":"auto","position":0.25,"command":"print(\"Running Utility Notebook to initialize all functions to use further\")","commandVersion":3,"state":"input","results":null,"resultDbfsStatus":"INLINED_IN_TREE","resultDbfsErrorMessage":null,"errorSummary":null,"errorTraceType":null,"error":null,"errorDetails":null,"baseErrorDetails":null,"workflows":[],"startTime":0,"submitTime":0,"finishTime":0,"collapsed":false,"bindings":{},"inputWidgets":{},"displayType":"table","width":"auto","height":"auto","xColumns":null,"yColumns":null,"pivotColumns":null,"pivotAggregation":null,"useConsistentColors":false,"customPlotOptions":{},"commentThread":[],"commentsVisible":false,"parentHierarchy":[],"diffInserts":[],"diffDeletes":[],"globalVars":{},"latestUser":"a user","latestUserId":null,"latestAssumeRoleInfo":null,"commandTitle":"","showCommandTitle":false,"hideCommandCode":false,"hideCommandResult":false,"isLockedInExamMode":false,"iPythonMetadata":null,"metadata":{},"streamStates":{},"datasetPreviewNameToCmdIdMap":{},"tableResultIndex":null,"listResultMetadata":[],"subcommandOptions":null,"contentSha256Hex":null,"tableResultSettingsMap":{},"nuid":"675aa3ab-88d2-4556-94ce-a693cc41beba"}],"dashboards":[],"guid":"2e48bac6-b050-4a33-bc9f-2faff91f8b22","globalVars":{},"iPythonMetadata":null,"inputWidgets":{},"notebookMetadata":{"pythonIndentUnit":4},"reposExportFormat":"JUPYTER","environmentMetadata":{"client":"4","base_environment":""},"computePreferences":null,"inputWidgetPreferences":null,"environmentSerializationPreferences":null}